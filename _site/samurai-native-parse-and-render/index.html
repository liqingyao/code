<!DOCTYPE html> <html lang="pt-br"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Samurai-Native 解析及渲染原理 </title> <meta name="description" content="Samurai-Native"> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://code.liqingyao.com/samurai-native-parse-and-render/"> <link rel="alternate" type="application/rss+xml" title="Li Qingyao" href="http://code.liqingyao.com/feed.xml" /> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-52446115-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-70794446-1', 'code.liqingyao.com'); ga('send', 'pageview'); </script> </head> <body class="samurai-native-parse-and-render"> <main class="main"> <header class="header"> <div class="overlay"> <div class="container"> <h1 class="title"> <a href="http://liqingyao.com">Li Qingyao</a> </h1> <nav class="navbar"> <a href="#" class="menu-icon"> <span></span> <span></span> <span></span> </a> <ul class="nav"> <li><a href="/about/">About</a></li> <li><a href="/categories/">Categories</a></li> <li><a href="/">Home</a></li> </ul> </nav> </div> <!-- --> </div> </header> <article class="post container card"> <header class="post-header"> <h1 class="post-title">Samurai-Native 解析及渲染原理</h1> <span class="post-meta"> <time class="post-date" datetime="2016-11-21">Nov 21, 2016</time> <span class="post-author"> &bull; in WebNative</span> </span> </header> <div class="post-content"> <h2 id="samurai-native">Samurai-Native</h2> <p>Samurai-Native 是 Hackers and Painters 出的第二款 Web-Native 框架，相对与其自家的第一款 BeeFramework 由 MVC、网络、文件系统等组成的大型框架而言，Samurai-Native 把动态 UI 下发的能力独立出来，并用标准的 HTML + CSS + Javascript 技术栈提供一套混合开发的解决方案，特点是相对轻量级些，集成的成本相对低一些，是客户端开发向前端迁移的优秀方案之一。</p> <p>Samurai-Native 支持标准的 HTML 标签，框架内转化为客户端的 Native 控件，同时也支持在 HTML 模板里直接把 Native 的控件名作为标签使用。标签的 name 属性支持动态数据绑定，布局方面支持标准 CSS 和 Flexbox 布局，事件处理采用高大上的 Signal Handling。</p> <p>这篇文章主要撸了 Samurai-Native 框架解析及渲染部分的实现流程和原理，事件处理方面的机制暂时没有涉及。</p> <h3 id="section">整体流程</h3> <p><img src="http://code.liqingyao.com/images/samurai-workflow.png" alt="workflow" /></p> <p>第一部分的解析流程：</p> <ol> <li>上层业务启动后，加载模板到 document</li> <li>从 document 解析 html 资源文件，生成一棵从标签映射过来的 domTree</li> <li>从 document 解析 css 资源文件，默认样式表、link 的外部样式表、type=”text/css” 定义的外联样式表和标签 style 定义的内部样式表分别解析到 document 对应对象中</li> </ol> <p>第二部分的 Reflow 流程：</p> <ol> <li>document 中样式有关对象合并到 styleSheet 对象中，以键值对形式按不同的类型（tag/id/class）保存在词典里</li> <li>处理 document 中外部导入的 html，把构成的 shadowTree 挂靠在相应 domTree 的节点上</li> </ol> <p>第三部分的渲染流程：</p> <ol> <li>遍历 domTree 上每个节点（包括 shadowRoot），对不同来源的样式按照优先级依次添加到节点的 computedStyle 上，包括处理节点的继承样式，此时 的 computedStyle 还是以键值对形式存储样式，而且存的值仍然是字符串形式</li> <li>从 domTree 映射到 renderTree，这步中根据节点的类型（document/element/text）和节点的层次（tree/branch/leaf/hidden）生成相应的渲染对象，同时计算 computedStyle 中存储的值或者转换为 OC 对象（比如 UIColor）</li> </ol> <p>第四部分的布局流程</p> <ol> <li>创建视图</li> <li>视图布局</li> </ol> <h3 id="section-1">关键类结构</h3> <ol> <li>祖先类 SamuraiTreeNode：Samurai-Native 框架中与 html/css/render/layout 相关类放在 samurai-webcore 文件目录下，其相关基础类放在 samurai-framework 文件目录下。SamuraiTreeNode 作为基石，是放在后面的目录下，主要定义了树形结构创建及修改相关的一些方法。</li> <li>资源类：基类 SamuraiResource 继承自 SamuraiTreeNode，负责记录资源文件路径、内容等信息并提供一些初始化方法，同时也是 SamuraiDocument、SamuraiStyleSheet 和 SamuraiScript的父类，这三个类分别对应模板、样式表和脚本解析后的对象。SamuraiDocument 会持有一棵从 html 映射来的 domTree，一个树状样式表 styleTree、一棵渲染树 renderTree，以及保存着外部导入文件 externalImports、externalScripts、externalStyleSheets。Samurai 解析实际使用的是 SamuraiHtmlDocument、SamuraiCSSStyleSheet 两个类，SamuraiHtmlDocument、SamuraiCSSStyleSheet 持有样式规则集 SamuraiCSSRuleSet 对象和规则选择器 SamuraiCSSRuleCollector 对象。</li> <li>内部树类：SamuraiDomNode 和 SamuraiRenderObject 直接继承自 SamuraiTreeNode，分别对应 Document 里的 domTree 和 renderTree 树结构，前者记录节点的类型、属性、标签，还会弱引用一个 SamuraiDocument 对象，用来在任意时候获取自身 document 的一些信息。他的子类 SamuraiHtmlDomNode 是框架中实际用到的 domTree 类型，持有用于实际计算样式的 computedStyle 样式和 shadowHost。另一个子类 SamuraiRenderObject 弱引用他的 domNode，并持有一个 SamuraiRenderStyle 对象和一个用于实际展示的视图，他的子类 SamuraiHtmlRenderObject 是实际使用的类。</li> </ol> <p>接下来看一下流程对应的关键调用栈。</p> <h2 id="parse-workflow">Parse Workflow</h2> <h3 id="section-2">加载资源</h3> <h3 id="html">解析 HTML</h3> <h3 id="css">解析 CSS</h3> <h2 id="reflow-workflow">Reflow Workflow</h2> <h3 id="stylesheet">合并 StyleSheet</h3> <h3 id="domtree">合并 DomTree</h3> <h2 id="render-workflow">Render Workflow</h2> <h3 id="stylesheet-1">分配 StyleSheet</h3> <h3 id="rendertree">建立 RenderTree</h3> <h2 id="layout-workflow">Layout Workflow</h2> <h3 id="view">创建 View</h3> <h3 id="view-1">布局 View</h3> <h2 id="section-3">有意思的插件</h2> <h2 id="section-4">性能测试</h2> <h2 id="section-5">思索时间</h2> <aside class="share"> <span>Share this to</span> <a href="http://twitter.com/share?text=Samurai-Native 解析及渲染原理&amp;url=http://code.liqingyao.com/samurai-native-parse-and-render/&amp;hashtags=web,dev,blog,soudev&amp;via=liqingyao"> <i class="fa fa-twitter-square"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://code.liqingyao.com/samurai-native-parse-and-render/"> <i class="fa fa-facebook-square"></i> </a> <a href="https://plus.google.com/share?url=http://code.liqingyao.com/samurai-native-parse-and-render/"> <i class="fa fa-google-plus-square"></i> </a> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http://code.liqingyao.com/samurai-native-parse-and-render/&title=Samurai-Native 解析及渲染原理&summary=Li Qingyao&source=http://code.liqingyao.com"> <i class="fa fa-linkedin-square"></i> </a> <!-- <a href="https://plus.google.com/share?url=http://code.liqingyao.com/samurai-native-parse-and-render/"> <i class="fa fa-wechat"></i> </a> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http://code.liqingyao.com/samurai-native-parse-and-render/&title=Samurai-Native 解析及渲染原理&summary=Li Qingyao&source=http://code.liqingyao.com"> <i class="fa fa-weibo"></i> </a> <a href="https://www.qq.com/share?url=http://code.liqingyao.com/samurai-native-parse-and-render/"> <i class="fa fa-qq"></i> </a> --> </aside> <hr> <aside id="comments" class="disqus"> <h2 class="txt-center">Comments</h2> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'codeliqingyao'; var disqus_identifier = '/samurai-native-parse-and-render'; var disqus_title = 'Samurai-Native 解析及渲染原理'; var disqus_url = 'http://code.liqingyao.com'; /*var disqus_developer = 1;*/ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a> </noscript> </aside> </div> </article> <footer class="footer t-center"> <div class="container"> <div class="social-icons"> <ul class="text-left"> <li><a href="https://github.com/liqingyao" target="_blank"><i class="fa fa-github"></i></a></li> <li><a href="http://weibo.com/leeleeannie" target="_blank"><i class="fa fa-weibo"></i></a></li> <li><a href="https://www.linkedin.com/in/liqingyao" target="_blank"><i class="fa fa-linkedin"></i></a></li> <li><a href="mailto:qingyao.li@yahoo.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li> </ul> </div> <small>&copy; 2016 Li Qingyao. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small> <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small> </div> </footer> </main> </body> </html></body></html>
<!--
// # Zetsu Jekyll theme - https://github.com/nandomoreriame/zetsu/
// by nandomoreira.me
-->
